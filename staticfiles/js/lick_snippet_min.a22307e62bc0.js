function canUseWebP(){var e=document.createElement("canvas");return!(!e.getContext||!e.getContext("2d"))&&0==e.toDataURL("image/webp").indexOf("data:image/webp")}function img_ext(){return canUseWebP()?".webp":".png"}function transposeChord(e,t){if(element=e.match(/(_[a-gA-g]{1,2}_)/)[0],t>=0)var s=["_C_","_Db_","_D_","_Eb_","_E_","_F_","_Gb_","_G_","_Ab_","_A_","_Bb_","_B_"];else s=["_C_","_B_","_Bb_","_A_","_Ab_","_G_","_Gb_","_F_","_E_","_Eb_","_D_","_Db_"];var a=s.indexOf(element);return element_transposed=s[(a+Math.abs(t))%s.length],e.replace(/(_[a-gA-g]{1,2}_)/,element_transposed)}function transposePlayer(e){transpose_bys[e]=Number(licks[e].getElementsByClassName("transpose-btn")[0].value),playback_rates[e]=licks[e].getElementsByClassName("slowdown-btn")[0].value,audios[e].playbackRate=playback_rates[e],players[e].playbackRate=playback_rates[e],players[e].toDestination();for(let e=0;e<pitch_shifts.length;e++)null!=pitch_shifts[e]&&pitch_shifts[e].disconnect(),delete pitch_shifts[e];1==playback_rates[e]?pitch_shifts[e]=new Tone.PitchShift({pitch:transpose_bys[e].toString()}).toDestination():(trans=transpose_bys[e]+12,trans=trans.toString(),pitch_shifts[e]=new Tone.PitchShift({pitch:trans}).toDestination()),players[e].disconnect(),players[e].connect(pitch_shifts[e])}function updateChords(e){l=lick_order.indexOf(e);let t,s=licks[l],a=s.getElementsByClassName("chord_seq")[0].getAttribute("value").split("x").slice(1,17),n=s.getElementsByClassName("transpose_rule")[0].getAttribute("value").split(","),o=Number(s.getElementsByClassName("transpose-btn")[0].value),i=s.getElementsByTagName("img");for(t=0;t<16;t++)i[t].hasAttribute("name")||(i[t].name=a[t]),"."==a[t]?i[t].src.endsWith("#")&&(i[t].src=chords_dir+n[t]+"/dash"+img_ext()):i[t].src=chords_dir+n[t]+"/"+transposeChord(a[t],o)+img_ext();null!=players[l]&&transposePlayer(l)}function make_ts34(e){let t=e.getElementsByClassName("chord-img");t[3].style.display="none",t[7].style.display="none",t[11].style.display="none",t[15].style.display="none",sep34=Array.prototype.slice.call(e.getElementsByClassName("separator-34")),sep34.forEach(function(e){e.style.width="2.9%"}),seplr=Array.prototype.slice.call(e.getElementsByClassName("separator-lr")),seplr.forEach(function(e){e.style.width="5%"}),sepmid=Array.prototype.slice.call(e.getElementsByClassName("separator-mid")),sepmid.forEach(function(e){e.style.width="8.8%"})}const licks=document.getElementsByClassName("lick"),lick_order=[];for(const e of licks)lick_order.push(e.id.split("_")[1]);const play_btns=document.getElementsByClassName("play"),seekBars=document.getElementsByClassName("seek-bar"),fillBars=document.getElementsByClassName("fill");mouseDown=!1,players=[],audios=[],playButtonIcons=[],playback_rates=[],transpose_bys=[],pitch_shifts=[];for(let e=0;e<play_btns.length;e++){34==licks[e].getElementsByClassName("time_signature")[0].getAttribute("value")&&make_ts34(licks[e]),playButtonIcons.push(play_btns[e].querySelector("span")),playback_rates.push(Number(licks[e].getElementsByClassName("transpose-btn")[0].value)),transpose_bys.push(licks[e].getElementsByClassName("slowdown-btn")[0].value),pitch_shifts.push(null),updateChords(lick_order[e])}function play(e){null==pitch_shifts[e]&&transposePlayer(e),audios[e].paused?(audios[e].play(),ofs=audios[e].currentTime,players[e].start(),players[e].seek(offset=ofs)):(audios[e].pause(),players[e].stop(0))}for(let e=0;e<play_btns.length;e++)play_btns[e].addEventListener("click",function(){if(null==players[e]){playButtonIcons[e].className="icon icon-spinner8";let t=play_btns[e].id.split("[X]")[1];players[e]=new Tone.Player(t),audios[e]=new Audio(t),audios[e].volume=0,transposePlayer(e),audios[e].addEventListener("play",function(){playButtonIcons[e].className="icon icon-pause",resetAudio(e)}),audios[e].addEventListener("pause",function(){playButtonIcons[e].className="icon icon-play"}),audios[e].addEventListener("timeupdate",function(){if(mouseDown)return;let t=audios[e].currentTime/audios[e].duration;fillBars[e].style.width=100*t+"%"}),seekBars[e].addEventListener("mousedown",function(t){mouseDown=!0,window.rect=t.target.getBoundingClientRect();let s=(t.clientX-rect.left)/seekBars[e].clientWidth;fillBars[e].style.width=100*s+"%"}),licks[e].addEventListener("mousemove",function(t){if(!mouseDown)return;let s=(t.clientX-rect.left)/seekBars[e].clientWidth;fillBars[e].style.width=100*s+"%"}),licks[e].addEventListener("mouseup",function(t){if(!mouseDown)return;mouseDown=!1;let s=(t.clientX-rect.left)/seekBars[e].clientWidth;fillBars[e].style.width=100*s+"%",audios[e].currentTime=s*audios[e].duration,ofs=audios[e].currentTime,audios[e].paused||(players[e].start(),players[e].seek(offset=ofs))})}!function t(){players[e].buffer.loaded?play(e):setTimeout(t,200)}()});function resetAudio(e){for(let t=0;t<play_btns.length;t++)null!=players[t]&&e!=t&&(audios[t].pause(),audios[t].currentTime=0,players[t].stop(0))}function slowdown(e){selected_tortoise=document.getElementById("slowdown_"+e),"1"==selected_tortoise.value?(selected_tortoise.src=tortoise_on_url,selected_tortoise.value="0.5"):(selected_tortoise.value="1",selected_tortoise.src=tortoise_off_url,selected_tortoise.value="1"),transposePlayer(lick_order.indexOf(e))}
