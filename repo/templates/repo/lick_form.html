{% extends "base.html" %}
{% load crispy_forms_tags %}
{% load static %}

{% block content %}

<link href="http://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css" rel="stylesheet">

<script type="text/javascript">
    //form submit when pressing Enter
    function noenter() {
        return !(window.event && window.event.keyCode == 13); }
</script>


<style type="text/css">
    .chords-row {
    height: 50px;
    background-image: url("{% static 'img/staff.png' %}");
    background-size: 100% 100%;
}


.audio-player {
    position: relative;
    display: flex;
    flex-direction: row;
    align-items: center;
    background-color: #f9f9f9;
    height: 40px;
    padding: 0px 0px 0px 5px;
}


.audio-player button.play {
        display: block;
        width: 35px;
        height: 35px;
        border: 0;
        background-color: #333333;
        color: white;
        font-size: 20px;
        border-radius: 5px;
        margin-right: 10px;
        cursor: pointer;
}


.seek-bar {

    margin-left: 10px;
    margin-right: 5px;
    width: 100%;
    background-color: #cccccc;
    display: flex;
    align-items: center;
    border-radius: 100000px;
    cursor: pointer;
}

.seek-bar .fill {
  height: 20px;
  background-color: #666666;
  border-radius: 100000px;
}

.seek-bar .handle {
  width: 8px;
  height: 20px;
  background-color: #333333;
  border-radius: 100000px;
  margin-left: -5px;
  transform: scale(2);
  transition: all 0.1s;
  pointer-events: none;
}


.preview-overlay {
    position: absolute;
    top: 0;
    right: 0;
    background-color: #f9f9f9;
    height: 100%;
    width: 100%;
    opacity: .8;
}

#inpFile {
    width: 0.1px;
    height: 0.1px;
    opacity: 0;
    overflow: hidden;
    position: absolute;
    z-index: -1;
}

#file_upload_info {
    color: #333333;
}


</style>





<div class="container-fluid col-12">


    <form class="lick-form" method="POST" enctype="multipart/form-data" onchange="changeLayout()">
        {% csrf_token %}

        <h2>New Lick</h2>
        <label for="inpFile" id="inpFileLabel" class="requiredField btn btn-secondary">Choose file</label>


        <input type="file" name="file" id="inpFile" class="clearablefileinput form-control" required/>

        <div id="file_upload_info">
            <p>Choose audio file of type '.mp3', '.m4a' or '.ogg'. <br> Length maximum 4 measures.</p>
        </div>

            <div class="audio-player col-12">
                  <button class="play" id="play" type="button"><i class="ion-play"></i></button>

                  <div class="seek-bar" id="seekbar">
                      <div class="fill"></div>
                      <div class="handle"></div>
                  </div>

                  <div class="preview-overlay" id="preview"></div>

            </div>



        <div class="time-signature row">
            <div class="col-4">
                {{ form.time_signature|as_crispy_field }}
            </div>
        </div>

        <button class="reset-chords-btn btn btn-secondary" id="reset_chords" onclick="resetChords()" type="button">Reset Chords</button>


        <div class="chords-input col-12">
        <div class="row chords-row">
                <div class="separator-lr"></div>
                {{ form.m1_b1|as_crispy_field }}
                {{ form.m1_b2|as_crispy_field }}
                {{ form.m1_b3|as_crispy_field }}
                {{ form.m1_b4|as_crispy_field }}
                <div class="separator-mid"></div>
                {{ form.m2_b1|as_crispy_field }}
                {{ form.m2_b2|as_crispy_field }}
                {{ form.m2_b3|as_crispy_field }}
                {{ form.m2_b4|as_crispy_field }}
                <div class="separator-lr"></div>
        </div>
        <div class="row chords-row">
                <div class="separator-lr"></div>
                {{ form.m3_b1|as_crispy_field }}
                {{ form.m3_b2|as_crispy_field }}
                {{ form.m3_b3|as_crispy_field }}
                {{ form.m3_b4|as_crispy_field }}
                <div class="separator-mid"></div>
                {{ form.m4_b1|as_crispy_field }}
                {{ form.m4_b2|as_crispy_field }}
                {{ form.m4_b3|as_crispy_field }}
                {{ form.m4_b4|as_crispy_field }}
                <div class="separator-lr"></div>
        </div>
        </div>

        <div class="form-input row">
            <div class="col-lg-6">
                {{ form.genre|as_crispy_field }}
            </div>
            <div class="col-lg-6">
                {{ form.instrument|as_crispy_field }}
            </div>
        </div>


<style type="text/css">

    input[placeholder] { text-overflow: ellipsis; }
    ::-moz-placeholder { text-overflow: ellipsis; } /* firefox 19+ */
    input:-moz-placeholder { text-overflow: ellipsis; }

  .tag-container, .suggested-tag-container{
    border: 2px solid #ccc;
    border-radius: 5px;
    padding: 5px;
    display: flex;
    flex-wrap: wrap;
    margin: 10px 10px;
    background: #ffff00;
  }

  .tag-container .tag, .suggested-tag-container .tag{
    border: 1px solid #ccc;
    border-radius: 3px;
    margin: 5px;
    padding: 0px 5px;
    display: flex;
    align-items: center;
    background: #f2f2f2;
    cursor: default;
  }

  .suggested-tag-container .tag{
    cursor: pointer;
  }

  .tag svg {
    margin-left: 5px;
    cursor: pointer;
  }

  .tag path {
    pointer-events: none;
  }

  .tag-container input{
    flex: 1;
    padding: 5px;
    outline: none;
    border: 0;
  }

</style>

        <label>Add tags</label>
        <div class="tag-container">
            <input onkeypress="return noenter()" placeholder="Type keyword, press Enter" required/>
        </div>

        <label>Suggested tags</label>
         <div class="suggested-tag-container">

        </div>

        <input type="hidden" id="tag_string" name="tag_string" value="TESTVALUE">
        <input type="hidden" id="tagsinput" data-role="tagsinput" class="form-control" name="tags">


<script type="text/javascript">


    //suggest tags
    suggested_tags_original = ["ballad", "swing", "latin", "bebop", "funk"];
    suggested_tags = suggested_tags_original.slice()
    const suggestedTagContainer = document.querySelector('.suggested-tag-container');

    function createSuggestedTag(label) {
        const div = document.createElement('div');
        div.setAttribute('class', 'tag');
        const span = document.createElement('span');
        span.innerHTML = label;
        div.appendChild(span);
        return div;
    }

    function updateSuggestedTags() {

        stc = document.querySelectorAll('.suggested-tag-container .tag')
        stc.forEach(function(tag){
            tag.parentElement.removeChild(tag);
        });

        suggested_tags.forEach(function(tag){
            const input = createSuggestedTag(tag);
            suggestedTagContainer.appendChild(input);
        });
    }

    updateSuggestedTags()


    suggestedTagContainer.addEventListener('click', function(e){
        if (e.target.tagName == 'SPAN'){
            const value = e.target.innerHTML;
            tags.push(value);
            addTags();
            updateTagString();
            const index = suggested_tags.indexOf(value);
            suggested_tags.splice(index,1);
            updateSuggestedTags();
        }
    });


    const tagContainer = document.querySelector('.tag-container');
    const input = document.querySelector('.tag-container input');
    const tagsinput = document.getElementById('tagsinput')
    //tagsinput.type = "hidden"
    var tags = [];

    function updateTagString(){
        ntags = []
        tags.forEach(function(tag){
            tag = tag.replace(/\s+/g, '_')
            ntags.push(tag);
        });
        string = ntags.join(",");
        tagsinput.value = string
        console.log(tagsinput.value);
    }

    function createTag(label) {
        const div = document.createElement('div');
        div.setAttribute('class', 'tag');
        const span = document.createElement('span');
        span.innerHTML = label;
        const closeBtn = document.createElement('i');
        closeBtn.setAttribute('class', 'fas fa-times-circle');
        closeBtn.setAttribute('data-item', label);
        div.appendChild(span);
        div.appendChild(closeBtn);
        return div;
    }

    function reset() {
        document.querySelectorAll('.tag-container .tag').forEach(function(tag){
            tag.parentElement.removeChild(tag);
        });
    }

    function addTags(){
        reset();
        tags.slice().reverse().forEach(function(tag){
            const input = createTag(tag);
            tagContainer.prepend(input);
        });
    }

    input.addEventListener('keyup', function(e){
        if (e.key == 'Enter' && input.value != ""){
            tags.push(input.value);
            addTags();
            updateTagString();
            input.value = '';
        }
    });

    tagContainer.addEventListener('click', function(e){
        if (e.target.tagName == 'svg'){
            const value = e.target.getAttribute('data-item');
            if (suggested_tags_original.indexOf(value) >= 0 && suggested_tags.indexOf(value) < 0){
                suggested_tags.push(value);
                updateSuggestedTags()
            }
            const index = tags.indexOf(value);
            tags.splice(index,1);
            addTags();
            updateTagString();
        }
    });

</script>

        <div class="form-submit">
            <button class="btn btn-primary btn-block btn-lg" type="submit" id="submit">Submit</button>
        </div>

    </form>

</div>



<!-- preview audio
<script type="text/javascript">
    /* https://www.youtube.com/watch?v=VElnT8EoEEM */
    const inpFile = document.getElementById("inpFile");
    const previewContainer = document.getElementById("filePreview");
    const previewAudio = previewContainer.querySelector(".file-preview__file");
    const previewDefaultText = previewContainer.querySelector(".file-preview__default-text");

    inpFile.addEventListener("change", function() {
        const file = this.files[0];

        if (file) {
            const reader = new FileReader();
            /* hide preview default text */
            previewDefaultText.style.display = "none";
            previewAudio.style.display = "block";

            reader.addEventListener("load", function() {
                previewAudio.setAttribute("src", this.result);
                audio = new Audio(this.result);
            });

            reader.readAsDataURL(file);
        } else {
            previewDefaultText.style.display = null;
            previewAudio.style.display = null;
        }
    });




</script>

 -->





<script type="text/javascript">


//// audio preview

//initial values
lick_URL = "{{ lick.file.url }}";
playButton = document.getElementById("play");
playButtonIcon = playButton.querySelector('i');
seekBar = document.getElementById("seekbar");
fillBar = seekBar.querySelector('.fill');
mouseDown = false;
preview = document.getElementById("preview");

//play button
playButton.addEventListener('click', function () {
    if (audio.paused) {
        audio.play();
    } else {
        audio.pause();
    }
});


function update_audio_controls() {

    preview.style.display = "none";

    audio.addEventListener('play', function () {
      playButtonIcon.className = 'ion-pause';
    });

    audio.addEventListener('pause', function () {
      playButtonIcon.className = 'ion-play';
    });

    audio.addEventListener('timeupdate', function () {
      if (mouseDown) return;
        let p = audio.currentTime / audio.duration;
        fillBar.style.width = p * 100 + "%";
    });

    seekBar.addEventListener('mousedown', function (e) {
      mouseDown = true;
      window.rect = e.target.getBoundingClientRect();
      let x = e.clientX - rect.left;
      let p = x / seekBar.clientWidth;
      fillBar.style.width = p * 100 + "%";
    });

    window.addEventListener('mousemove', function (e) {
      if (!mouseDown) return;
        let x = e.clientX - rect.left;
        let p = x / seekBar.clientWidth;
        fillBar.style.width = p * 100 + "%";
    });

    window.addEventListener('mouseup', function (e) {
      if (!mouseDown) return;
        mouseDown = false;
        let x = e.clientX - rect.left;
        let p = x / seekBar.clientWidth;
        fillBar.style.width = p * 100 + "%";
        audio.currentTime = p * audio.duration;
      if (!audio.paused) {
        audio.play();
      }
    });

};

function audio_reset(){
    if (typeof audio != 'undefined') {
        audio.pause();
        audio.currentTime = 0;
        playButtonIcon.className = 'ion-play';
    }
}

submit_btn = document.getElementById("submit");
initial_submit_classname = submit_btn.className

function disable_submit_btn(){
    if (submit_btn.className == initial_submit_classname){
        submit_btn.className += " btn-secondary disable";
        submit_btn.type = "button";
    }
}

if (lick_URL) {
    audio = new Audio("{{ lick.file.url }}");
    update_audio_controls();
}

// get audio file src from input field
inpFile = document.getElementById("inpFile");
inpFileLabel = document.getElementById("inpFileLabel")
file_upload_info = document.getElementById("file_upload_info")


inpFile.addEventListener("change", function() {
    audio_reset();
    file = this.files[0];
    inpFileLabel.textContent=file.name;
    //file_upload_info.innerHTML = "Choose audio file of type .mp3 .m4a or .ogg. Max size 1 MB.";
    preview.style.display = "hidden";
    submit_btn.className = initial_submit_classname
    submit_btn.type = "submit";

    if (file == null) {
        inpFileLabel.textContent="Choose File";
        preview.style.display = "block";
        disable_submit_btn()
    } else if (!(file.type.split("/")[0] == "audio")) {
        file_upload_info.innerHTML = "Wrong file type. Please use audio, preferably '.mp3', '.m4a' or '.ogg'.";
        file_upload_info.style.color = "#ff0000"
        preview.style.display = "block";
        disable_submit_btn()
    } else if (file.size > 1048576) {
        file_upload_info.innerHTML = "File too large (limit 1 MB). Consider shortening audio.";
        file_upload_info.style.color = "#ff0000"
        preview.style.display = "block";
        disable_submit_btn()
    } else {
        file_upload_info.innerHTML = "";
        reader = new FileReader();
        reader.addEventListener("load", function() {
            audio = new Audio(this.result);
            update_audio_controls();
        });
        reader.readAsDataURL(file);
    }
});




//// change layout when select 3/4

function changeLayout() {
    if (document.getElementById("id_time_signature_1").checked){
        $(".ts44").show();
        $(".chords-row .form-group").css("width","11.5%");
    } else if (document.getElementById("id_time_signature_2").checked){
        $(".ts44").hide();
        $(".chords-row .form-group").css("width","15.33%");
        $("#div_id_m1_b4, #div_id_m2_b4, #div_id_m3_b4, #div_id_m4_b4").css("width","0px");
        document.getElementById("id_m1_b4").selectedIndex = "-";
        document.getElementById("id_m2_b4").selectedIndex = "-";
        document.getElementById("id_m3_b4").selectedIndex = "-";
        document.getElementById("id_m4_b4").selectedIndex = "-";
    }
};



//// reset chords button

function resetChords() {
    console.log("reset chords")
}


</script>


{% endblock content %}


