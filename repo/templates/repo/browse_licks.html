{% extends "base.html" %}
{% load crispy_forms_tags %}
{% load static %}
{% load repo_extras %}


{% block content %}

<script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.5.35/Tone.js"></script>
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js" type="text/javascript"></script>

<script type="text/javascript">
    //suppress form submit when pressing Enter
    function noenter() {
        return !(window.event && window.event.keyCode == 13); }

</script>


<style type="text/css">
.chords-row {
    background-image: url("{% static 'img/staff.png' %}");
}
</style>

{% include 'repo/snippets/lick_snippet_style.html' %}





<style type="text/css">




.lick-form {
    margin-top: 50px;
    margin-bottom: 100px;
    background: #f9f9f9;
    width: 100%;
    padding: 5px;
    border: 2px solid #234444;
    border-radius: 15px;
}


.form-chords-row {
    height: 50px;
    background-image: url("{% static 'img/staff.png' %}");
    background-size: 100% 100%;
}


.form-chords-input .chord-select {
    width: 11.5%;
    max-width: 100%;
    -webkit-appearance: none;
    -moz-appearance: none;
    font-size: 1rem;
    font-weight: 400;
    color: #495057;
    padding: 0rem;
    margin: 5px 0px;
    background-color: #fff;
    border: 1px solid #ced4da;
    border-radius: .25rem;
    transition: border-color .15s ease-in-out,box-shadow .15s ease-in-out;
}

.separator-mid{
    width: 4%;
}
.separator-lr{
    width: 2%;
}


/*time signature radio btns next to each other*/
.form-check {
    display: inline-block;
    margin-right: 10px;
}



.tag-section{
    /*background: #ff0000;*/
    border: 2px solid #ccc;
    border-radius: 5px;
    margin: 10px 10px;
}

.tag-section hr{
    margin: 0px;
}
.tag-container, .suggested-tag-container{
    margin: 0px;
    padding: 5px;
    display: flex;
    flex-wrap: wrap;
}

.tag-container .tag, .suggested-tag-container .tag{
    border: 1px solid #ccc;
    border-radius: 3px;
    margin: 5px;
    padding: 0px 5px;
    display: flex;
    align-items: center;
    background: #e0e0e0;
    cursor: default;
}

.suggested-tag-container .tag{
    cursor: pointer;
}

.tag-container input{
    flex: 1;
    padding: 5px;
    outline: none;
    border: 0;
}

.tag svg {
    margin-left: 5px;
    cursor: pointer;
}

.tag path {
    pointer-events: none;
}


</style>



<!--data-toggle="collapse"-->
<!--class="collapse"-->

<button class="search-btn col-lg-12 btn-info btn-lg" data-target="#search">Search Licks  <i class="fas fa-search"></i></button>
<div id="search">


<form class="lick-form" method="GET" enctype="multipart/form-data">


    <div id="time-signature">
        <div class="form-check">
            <input type="radio" class="form-check-input" checked="checked" name="ts" id="id_time_signature_1" value="44">
            <label for="id_time_signature_1" class="form-check-label">4/4</label>
        </div>
         <div class="form-check">
            <input type="radio" class="form-check-input" name="ts" id="id_time_signature_2" value="34">
            <label for="id_time_signature_2" class="form-check-label">3/4</label>
        </div>
    </div>

    <button class="reset-chords-btn btn btn-secondary" id="reset_chords" type="button">Reset Chords</button>

    <div class="form-chords-input col-12">
    <div class="row form-chords-row">
            <div class="separator-lr"></div>
            {% include 'repo/snippets/chord_select_snippet.html' %}
            {% include 'repo/snippets/chord_select_snippet.html' %}
            {% include 'repo/snippets/chord_select_snippet.html' %}
            {% include 'repo/snippets/chord_select_snippet.html' %}
            <div class="separator-mid"></div>
            {% include 'repo/snippets/chord_select_snippet.html' %}
            {% include 'repo/snippets/chord_select_snippet.html' %}
            {% include 'repo/snippets/chord_select_snippet.html' %}
            {% include 'repo/snippets/chord_select_snippet.html' %}
            <div class="separator-lr"></div>
    </div>
    <div class="row form-chords-row">
            <div class="separator-lr"></div>
            {% include 'repo/snippets/chord_select_snippet.html' %}
            {% include 'repo/snippets/chord_select_snippet.html' %}
            {% include 'repo/snippets/chord_select_snippet.html' %}
            {% include 'repo/snippets/chord_select_snippet.html' %}
            <div class="separator-mid"></div>
            {% include 'repo/snippets/chord_select_snippet.html' %}
            {% include 'repo/snippets/chord_select_snippet.html' %}
            {% include 'repo/snippets/chord_select_snippet.html' %}
            {% include 'repo/snippets/chord_select_snippet.html' %}
            <div class="separator-lr"></div>
    </div>
    </div>



    <div id="chord_seq_field">
            {{ form.chord_seq|as_crispy_field }}
    </div>


    <div class="time-signature row">
        <div class="form-group col-md-4">
            <input type="checkbox" id="include_transposed" name="include_transposed" value="True">
            <label for="vehicle1"> Include transposed</label><br>
        </div>
        <div class="form-group col-md-4">
            <input type="checkbox" id="ignore_extensions" name="ignore_extensions" value="True">
            <label for="vehicle1">Ignore extensions</label><br>
        </div>
        <div class="form-group col-md-4">
            <input type="checkbox" id="exact_search" name="exact_search" value="True">
            <label for="vehicle1">Exact search</label><br>
        </div>
    </div>

    <div class="form-row">
        <div class="form-group col-md-4">
            <label for="category">Time signature</label>
            <select id="time_signature" class="form-control" name="time_signature">
                <option value="" selected>Any</option>
                <option value="44">4/4</option>
                <option value="34">3/4</option>
            </select>
        </div>

        <div class="form-group col-md-4">
            <label for="category">Instrument</label>
            <select id="instrument" class="form-control" name="instrument">
                <option value="" selected>Any</option>
                {% for ins in instrument %}
                <option value="{{ ins }}">{{ ins }}</option>
              {% endfor %}
            </select>
        </div>
    </div>

    <div class="form-row">
        <div class="form-group col-md-4">
            <label for="category">Author</label>
            <input class="form-control py-2 border-right-0 border" type="search" name="username_contains" placeholder="username contains..." value="{{ username_contains_query }}">
        </div>
        <div class="form-group col-md-4">
            <label for="category">lick #</label>
            <input class="form-control py-2 border-right-0 border" type="search" name="lick_id" placeholder="lick ID..." value="{{ lick_id_query }}">
        </div>
    </div>


    <label>Add tags</label>

    {{ form.tags|as_crispy_field }}
    <!--
    <input type="text" name="tags" class="tagwidget form-control" required="" id="id_tags">
    -->

    <div class="tag-section">
        <div class="tag-container">
            <input onkeypress="return noenter()" placeholder="Type keyword, press Enter"/>
        </div>
    <hr>
         <div class="suggested-tag-container">

        </div>
    </div>

    <input type="hidden" id="tag_string" name="tag_string" value="TESTVALUE">

    <!--
    <input type="hidden" id="hiddenTagsInput" data-role="hiddenTagsInput" class="form-control" name="hiddenTagsInput">
    -->
    <div class="form-submit">
        <button class="btn btn-primary btn-block btn-lg" type="submit" id="submit">Submit</button>
    </div>

</form>


</div>

{% if licks.has_other_pages %}

    {% if licks.has_previous %}
      <a class = "btn btn-outline-info mb-4" href="?{% url_replace request 'page' 1 %}">First</a>
      <a class = "btn btn-outline-info mb-4" href="?{% url_replace request 'page' licks.previous_page_number %}">Prev</a>
    {% endif %}

    {% for num in licks.paginator.page_range %}
      {% if licks.number == num %}
        <a class = "btn btn-info mb-4" href="?{% url_replace request 'page' num %}">{{ num }}</a>
      {% elif num > licks.number|add:'-5' and num < licks.number|add:'5'%}
        <a class = "btn btn-outline-info mb-4" href="?{% url_replace request 'page' num %}">{{ num }}</a>
      {% endif %}
    {% endfor %}

    {% if licks.has_next %}
      <a class = "btn btn-outline-info mb-4" href="?{% url_replace request 'page' licks.next_page_number %}">Next</a>
      <a class = "btn btn-outline-info mb-4" href="?{% url_replace request 'page' licks.paginator.num_pages %}">Last</a>
    {% endif %}

{% endif %}


{% if licks %}

    {% for lick in licks %}

    {% include 'repo/snippets/lick_snippet.html' with lick=lick chord_seq_query=chord_seq_query %}

    {% endfor %}

{% else %}
    <div class="alert alert-primary" role="alert">
       No licks found... Try searching for something else.
    </div>

{% endif %}


{% if licks.has_other_pages %}

    {% if licks.has_previous %}
      <a class = "btn btn-outline-info mb-4" href="?{% url_replace request 'page' 1 %}">First</a>
      <a class = "btn btn-outline-info mb-4" href="?{% url_replace request 'page' licks.previous_page_number %}">Prev</a>
    {% endif %}

    {% for num in licks.paginator.page_range %}
      {% if licks.number == num %}
        <a class = "btn btn-info mb-4" href="?{% url_replace request 'page' num %}">{{ num }}</a>
      {% elif num > licks.number|add:'-5' and num < licks.number|add:'5'%}
        <a class = "btn btn-outline-info mb-4" href="?{% url_replace request 'page' num %}">{{ num }}</a>
      {% endif %}
    {% endfor %}

    {% if licks.has_next %}
      <a class = "btn btn-outline-info mb-4" href="?{% url_replace request 'page' licks.next_page_number %}">Next</a>
      <a class = "btn btn-outline-info mb-4" href="?{% url_replace request 'page' licks.paginator.num_pages %}">Last</a>
    {% endif %}

{% endif %}




{% include 'repo/snippets/lick_snippet_js.html' %}

<script type="text/javascript">



//// get chords string

// number all chord select and assign ids

const chord_select = document.getElementsByClassName("chord-select");

var counter = 1
for (let chord of chord_select) {
    chord.id = "chord_"+counter.toString()
    counter += 1

}

// hide chord seq field
const chord_seq_field = document.getElementById("chord_seq_field");
//chord_seq_field.style.display = "none";

// update chord seq upon change of chords
function updateChordSeq(){
    let chord_seq = "x"
    for (let chord of chord_select) {
        chord_seq = chord_seq + chord.value + "x"
    }
    document.getElementById("id_chord_seq").value = chord_seq
}

document.querySelectorAll('.chord-select').forEach(item => {
    item.addEventListener("change", function(){
        updateChordSeq();
    });
})



//// reset chords button

const reset_chords_btn = document.getElementById("reset_chords")

reset_chords_btn.addEventListener("click", function(){
    for (let chord of chord_select) {
        chord.value = "."
    };
    updateChordSeq();
})




// Time Signature Controls

function changeLayout() {
    if (document.getElementById("id_time_signature_1").checked){
        $("#chord_4").show();
        $("#chord_8").show();
        $("#chord_12").show();
        $("#chord_16").show();
        $(".form-chords-row .chord-select").css("width","11.5%");
    } else if (document.getElementById("id_time_signature_2").checked){
        $("#chord_4").hide();
        $("#chord_8").hide();
        $("#chord_12").hide();
        $("#chord_16").hide();
        $(".form-chords-row .chord-select").css("width","15.33%");
        $("#chord_4, #chord_8, #chord_12, #chord_16").css("width","0px");
        document.getElementById("chord_4").value = ".";
        document.getElementById("chord_8").value = ".";
        document.getElementById("chord_12").value = ".";
        document.getElementById("chord_16").value = ".";
    }
    updateChordSeq();
};


time_sign_input = document.getElementById('time-signature')
time_sign_input.addEventListener("change", function(){
 changeLayout();
});



//// Tag controls


const suggested_tags_original = ["jazz", "ballad", "swing", "bebop", "waltz", "latin", "bossa", "salsa", "montuno", "funk", "country", "rock", "metal", "scales", "blues", "gospel", "spiritual", "turnaround", "even_eights", "shuffle"];
var suggested_tags = suggested_tags_original.slice()

const suggestedTagContainer = document.querySelector('.suggested-tag-container');
const tagContainer = document.querySelector('.tag-container');
const tagsInput = document.querySelector('.tag-container input');
const hiddenTagsInput = document.getElementById('id_tags') // hidden input
hiddenTagsInput.required = false;
//hiddenTagsInput.type = "hidden"

var tags = [];

function createTag(label, close="") {
    const div = document.createElement('div');
    div.setAttribute('class', 'tag');
    const span = document.createElement('span');
    span.innerHTML = label;
    div.appendChild(span);
    if (close){
        const closeBtn = document.createElement('i');
        closeBtn.setAttribute('class', 'fas fa-times-circle');
        closeBtn.setAttribute('data-item', label);
        div.appendChild(closeBtn);
    }
    return div;
}


function updateTags(){
    // remove all tags (reset)
    document.querySelectorAll('.tag-section .tag').forEach(function(tag){
        tag.parentElement.removeChild(tag);
    });

    // update selected tags
    tags.slice().reverse().forEach(function(tag){
        tagContainer.prepend(createTag(tag, close="Yes"));
    });

    // update suggested tags
    suggested_tags.forEach(function(tag){
        suggestedTagContainer.appendChild(createTag(tag, close=""));
    });
    // update hidden tag field
    hiddenTagsInput.value = tags.join(",")
    console.log(hiddenTagsInput.value);
}

updateTags()


// input tags

function sanitizeKey(key){
    key = key.replace(/^#+/g, '');
    key = key.replace(/^\s+/g, '');
    key = key.replace(/\s+$/g, '');
    key = key.replace(/\s+/g, '_');
    key = key.toLowerCase();
    return key;
}

tagsInput.addEventListener('keyup', function(e){
    let keyword = tagsInput.value
    if (e.key == 'Enter' && keyword != ""){
        keyword = sanitizeKey(keyword);
        if (tags.indexOf(keyword) < 0) {
            tags.push(keyword);
            let st_index = suggested_tags.indexOf(keyword)
            if (st_index >= 0){
                    suggested_tags.splice(st_index,1);
            }
        }
        updateTags();
        tagsInput.value = '';
    }
});


// delete tag from input list
tagContainer.addEventListener('click', function(e){
    if (e.target.tagName == 'svg'){
        let keyword = e.target.getAttribute('data-item');
        if (suggested_tags_original.indexOf(keyword) >= 0 && suggested_tags.indexOf(keyword) < 0){
            suggested_tags.push(keyword);
        }
        let t_index = tags.indexOf(keyword);
        tags.splice(t_index,1);
        updateTags();
    }
});

// select tag from suggested list
suggestedTagContainer.addEventListener('click', function(e){
    if (e.target.tagName == 'SPAN'){
        let keyword = e.target.innerHTML;
        tags.push(keyword);
        let st_index = suggested_tags.indexOf(keyword);
        suggested_tags.splice(st_index,1);
        updateTags();
    }
});





</script>

{% endblock content %}
